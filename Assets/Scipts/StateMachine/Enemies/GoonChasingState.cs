using UnityEngine;
using UnityEngine.AI;

public class GoonChasingState : ChasingState
{
    /// <summary>
    /// Таймер проверки союзных существ
    /// </summary>
    private float _timerCheckAlliesNearby;

    /// <summary>
    /// Маска слоев с одним слоем Enemy, который мы будем искать
    /// </summary>
    private LayerMask collisionMask = 4096;

    public GoonChasingState(EnemyUnit enemyUnit) : base(enemyUnit)
    {

    }
    public override void Enter()
    {
        base.Enter();

        // Обнуляем таймер
        _timerCheckAlliesNearby = 0;

        // Включаем анимацию для этого состояния, задаем параметр анимации
        enemyUnit.Animator.SetBool(HashAnimStringEnemy.IsMovement, true);
    }

    public override void Update()
    {
        base.Update();

        _timerCheckAlliesNearby += Time.deltaTime;

        if (_timerCheckAlliesNearby > 3f)
        {
            // Получаем кол-во союзных существ поблизости
            int countAlliesNearby = GetCountAlliesNearby();

            // Если их больше 2х, то кастуем баф
            if (countAlliesNearby > 2 && !((Goon)enemyUnit).IsWarcryInCooldown)
            {
                enemyUnit.SetState<InspirationState>();
            }

            // Обнуляем таймер
            _timerCheckAlliesNearby = 0;
        }

        // Если противник подошел на дистанцию атаки (_attackDistance), то изменяем состояние
        if (distanceEnemyToPlayer < enemyUnit.AttackDistance)
        {
            // Изменяем состояние на состояние атаки
            enemyUnit.SetState<GoonAttackState>();
        }
    }

    public override void Exit()
    {
        base.Exit();

        // Включаем анимацию для этого состояния, задаем параметр анимации
        enemyUnit.Animator.SetBool(HashAnimStringEnemy.IsMovement, false);
    }

    private int GetCountAlliesNearby()
    {
        Vector3 center = enemyUnit.transform.position;
        float radius = 8;

        Collider[] hitColliders = Physics.OverlapSphere(center, radius, collisionMask);

        return hitColliders.Length;

    }
}
